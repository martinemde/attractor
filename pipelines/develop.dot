digraph Develop {
    graph [
        goal="Implement the next feature against the specification",
        retry_target="implement"
    ]
    node [shape=box, timeout="900s"]

    start     [shape=Mdiamond, label="Start"]
    exit      [shape=Msquare, label="Exit"]

    read_spec [
        label="Read Spec",
        prompt="Read the specification files and existing source code.
Summarize the current state: what is implemented, what is missing.
Identify the highest-priority unfinished item for: $goal"
    ]

    implement [
        label="Implement",
        prompt="Implement the changes identified in the previous step.
Follow existing code patterns. Run go build ./... to verify compilation.",
        goal_gate=true
    ]

    test [
        label="Test",
        prompt="Run go test ./... and report results.
If tests fail, analyze failures and describe what needs fixing."
    ]

    gate [shape=diamond, label="Tests Pass?"]

    start -> read_spec -> implement -> test -> gate
    gate -> exit      [label="Yes", condition="outcome=success", weight=10]
    gate -> implement [label="No",  condition="outcome!=success"]
}
